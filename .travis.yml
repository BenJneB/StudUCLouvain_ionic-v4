env:
  global:
    - CC_TEST_REPORTER_ID=9e94eb42394f339fee6592314b209bd1afb92b11580fee8e550111aa42626990
    - ANDROID_API_LEVEL=28
    - ANDROID_BUILD_TOOLS_VERSION=28.0.3
    - ANDROID_ABI=armeabi-v7a
jdk: oraclejdk8

language: node_js
node_js: "12.12.0"
android:
  components:
    - tools
    - platform-tools
    - build-tools-28.0.3
    - android-28
    - extra-android-m2repository
dist: xenial
services:
  - xvfb
addons:
  chrome: stable
  apt:
    sources:
      - sourceline: deb https://dl.yarnpkg.com/debian/ stable main
        key_url: https://dl.yarnpkg.com/debian/pubkey.gpg
    packages:
      - oracle-java8-installer
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache

before_install:
    #- touch $HOME/.android/repositories.cfg
branches:
      only:
      - master

before_script:
      - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
      - chmod +x ./cc-test-reporter
      - ./cc-test-reporter before-build

jobs:
  include:
    - stage: "Tests"
      name: "Unit Tests"
      script: npm run test:onceAndCoverage
    - script: npm run e2e
      name: "E2E Tests"
    - script: ionic cordova build browser --prod
      before_script:
        - npm install -g ionic cordova
        - ionic cordova platform add browser
      name: "Build browser"
      deploy:
        provider: pages
        skip-cleanup: true
        github-token: $GITHUB_TOKEN
        keep-history: true
        on:
          branch: master
        local_dir: www
    - script: ionic cordova build android --prod
      before_script:
        - npm install -g ionic cordova cordova-res
        - ionic cordova resources android
        - ionic cordova platform add android
      name: "Build Android"
      deploy:
        provider: pages
        skip-cleanup: true
        github-token: $GITHUB_TOKEN
        keep-history: true
        on:
          repo: BenJneB/StudUCLouvain_ionic-v4
          branch: master

after_script:
  - ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT

